# S：迹重建系统（形式化规范）


## 0. 符号约定

* 若未另行说明，$\mathbb{N}$ 包含 $0$。

* 给定集合 $X$，记 $\mathcal{P}\_{\text{fin}}(X)$ 为 $X$ 的所有**有限子集**。

* 若 $f$ 为偏函数，写 $f: A \rightharpoonup B$。

* 对列表/序列 $\tau$，记 $\tau = [\rho\_1,\dots,\rho\_n]$，其长度为 $|\tau|=n$。$\tau\mathbin{\small{\tt ++}}[\rho]$ 表示在尾部追加元素。$\mathsf{last}(\tau)$ 表示最后一个元素（当 $|\tau|\ge 1$ 时定义）。空列表记为 $[]$。

---

## 1. 基础集合与原语

1. **原子项 (Atoms)**：可数集合 $A$。

2. **位点标识符 (Site identifiers)**：可数集合 $V$（元素记为 $v,w,\dots$）。

3. **函数符号 (Function symbols)**：集合 $F$，对于每个 $f\in F$ 有元数 $\mathsf{arity}(f)\in\mathbb{N}\_{>0}$。

4. **内部状态集 (Internal states)**：非空有限或可数集合 $S$（元素记为 $s$）。

5. **验证位点状态集**：$S\_\nu={\mathsf{AVAILABLE},;\mathsf{CONSUMED}}$。

6. **规则节点集合占位符**：记为 $P$（之后规则节点由三元组构造）。

---

## 2. 项 (Terms)、位点项 (Site terms) 与上下文 (Contexts)

### 2.1 项族

定义项集合 $\mathcal{T}$（缩写为 $T$）为满足下列归纳规则的最小集合：

1. 若 $a\in A$，则 $a\in T$（原子项）。

2. 若 $v\in V$ 且 $s\in S$，则位点项 $\sigma=(v,s)$ 为一个项。记这类项为 $\mathsf{Site}(V,S)\subseteq T$。

3. 若 $f\in F$ 且 $\mathsf{arity}(f)=n$ 且 $t\_1,\dots,t\_n\in T$，则 $f(t\_1,\dots,t\_n)\in T$。

对于每个位点项 $\sigma=(v,s)$，定义投影函数：

$\mathsf{id}(\sigma)=v,\qquad \mathsf{state}(\sigma)=s.$

### 2.2 位置 (Positions)、子项与上下文

* 位置集 $\mathsf{Pos}(t)$：对于任意项 $t\in T$，其位置集由树状表示定义，位置为有限序列 $p\in\mathbb{N}^\*$（包括空序列 $\epsilon$ 表示根）。标准的子项与上下文操作如下：

* 子项提取：$t|\_p$ 表示 $t$ 在位置 $p$ 处的子项（当 $p\in\mathsf{Pos}(t)$ 时定义）。

* 替换：$t[p:=u]$ 表示把 $t$ 在位置 $p$ 处的子项替换为项 $u$。

* 上下文 $\mathcal{C}$ 定义为带**单一空位**的项。等价地，一个上下文 $C$ 可视为一个项位置 $p$ 与一个项 $t$ 的组合，使得 $t= C[;\square;]$ 且把空位置于 $p$。对上下文 $C$ 与任意项 $u$，记 $C[u]$ 为把空位替换为 $u$ 的项（等价于 $t[p:=u]$）。

**性质**：对任意项 $t$ 与其任一位置 $p$，存在唯一的上下文 $C$ 与子项 $u$ 使得 $t = C[u]$ 且 $u=t|\_p$。

---

## 3. 规则节点 (Rule Nodes) 与 迹 (Traces)

### 3.1 规则节点

一个**规则节点** $\rho$ 是一个三元组

$\rho = (\sigma_{\mathrm{lhs}},\ t_{\mathrm{rhs}},\ C_{\mathrm{trigger}})$

满足：

* $\sigma\_{\mathrm{lhs}}\in\mathsf{Site}(V,S)$（即左侧是位点项）；

* $t\_{\mathrm{rhs}}\in T$；

* $C\_{\mathrm{trigger}}\in\mathcal{C}$ 是带单一空位的上下文。

记规则节点集合为 $P\subseteq \mathsf{Site}(V,S)\times T\times\mathcal{C}$（在模型中 $P$ 是所有可用规则节点的集合）。

定义辅助投影：

\begin{align\*}

\mathsf{lhs}(\rho)&=\sigma\_{\mathrm{lhs}},\\

\mathsf{rhs}(\rho)&=t\_{\mathrm{rhs}},\\

\mathsf{trigger}(\rho)&=C\_{\mathrm{trigger}}.

\end{align\*}

并要求规则的一致性约束：若 $\rho\in P$ 且 $\rho=(\sigma,t,C)$，则 $C[t]$ 是一个项（显然成立），且不要求额外的约束，除非系统显式指定。

### 3.2 迹（Traces）

一个**迹** $\tau$ 是 $P$ 中规则节点的有限序列：

$\tau=[\rho_1,\rho_2,\dots,\rho_n]\quad(\rho_i\in P).$

空迹为 $[]$。

---

## 4. 验证位点 (Validation sites) 与验证函数 (Validators)

### 4.1 验证位点

一个**验证位点**记为 $\nu$，其结构为三元组：

$\nu = (\sigma,\ s_{\nu},\ A)$

其中：

* $\sigma\in\mathsf{Site}(V,S)$ 为该验证位点的**源位点项**（简称 origin）；

* $s\_{\nu}\in S\_\nu ={\mathsf{AVAILABLE},\mathsf{CONSUMED}}$ 为其当前验证状态；

* $A$ 为该验证位点的**验证函数（validator）**。

定义投影：

$\mathsf{origin}(\nu)=\sigma,\qquad \mathsf{val\_state}(\nu)=s_{\nu},\qquad \mathsf{validator}(\nu)=A.$

验证位点的集合记为 $\mathcal{V}$。

### 4.2 验证函数的形式化签名

为避免歧义，采取以下**封闭化（closure）式签名**：每个验证位点携带一个针对其源位点的局部验证函数

$A:\;\mathcal{C} \to P\cup\{\bot\},$

满足对所有上下文 $C\in\mathcal{C}$，若 $A(C)=\rho\ne\bot$，则应满足 $\mathsf{lhs}(\rho)=\mathsf{origin}(\nu)$（即返回的规则节点的左侧必须与该验证位点的 origin 相同）。

等价地，我们也可视 $A$ 为

$A:\;\mathsf{Site}(V,S)\times\mathcal{C} \to P\cup\{\bot\}$

但在实现/定义上，每个 $\nu$ 保证 $A$ 已被部分应用（捕获了 origin），因此本规范采用前者表述并在需要时写为 $A\_\sigma(C)$ 表示源自 $\sigma$ 的 validator 的应用。

**可计算性/复杂度假设（参数化）**：系统参数化一个关于 validator 的性质。默认假设：对于所有 $\nu$，$A$ 为可判定（可计算）函数；若要研究更强的可表示性可放宽为任意部分可计算函数。具体假设在系统实例中指明。

---

## 5. 系统格局 (System configuration) 与初始条件

### 5.1 系统格局

一个系统格局（configuration）定义为二元组：

$(\tau,\Sigma)$

其中：

* $\tau\in\mathsf{Traces}$ 为当前迹；

* $\Sigma: V \rightharpoonup \mathcal{V}$ 为从位点标识符到验证位点的**部分映射**（记录系统中已出现位点的当前验证位点状态）。

记 $\mathsf{dom}(\Sigma)={v\in V\mid \Sigma(v)\ \text{已定义}}$。

### 5.2 系统参数：新位点初始化函数

系统提供一个**初始化函数**

$\mathsf{init}\;:\;\mathsf{Site}(V,S)\to(\mathcal{C}\to P\cup\{\bot\})$

用于当创建一个新的验证位点（来源于某个位点项 $\sigma$）时给出默认的 validator（即 $\mathsf{init}(\sigma)$）。在实现上可以把 $\mathsf{init}$ 视作把 $\sigma$ 映射到一个 validator 的工厂函数。

### 5.3 新名生成公理（freshness）

假定 $V$ 为可数且无限。定义一个函数

$\mathsf{fresh}:\;\mathcal{P}_{\text{fin}}(V)\to V$

满足对任意有限集 $D\subseteq V$：

$\mathsf{fresh}(D)\in V\setminus D.$

此公理保证在需要引入新的位点标识符时可产生与现有不同的新 id。

---

## 6. 出现与新位点的判定

定义函数 $\mathsf{Sites}(t)$（对 $t\in T$）为 $t$ 中出现的**所有**位点项的集合：

$\mathsf{Sites}(t)=\{\sigma\in\mathsf{Site}(V,S)\mid \exists p\in\mathsf{Pos}(t): t|_p=\sigma\}.$

若 $\Sigma$ 为当前映射，则称 $\sigma\in\mathsf{Sites}(t)$ 为**新的**（相对 $\Sigma$）当且仅当 $\mathsf{id}(\sigma)\notin\mathsf{dom}(\Sigma)$。

---

## 7. 单步扩展规约（One-step extension relation）

下面精确给出格局之间的单步扩展关系 $;\xrightarrow{; };\subseteq (\mathsf{Traces}\times(V\rightharpoonup\mathcal{V}))^2$。写作

$(\tau,\Sigma) \xrightarrow{\;} (\tau',\Sigma')$

当且仅当存在满足以下前提的对象，使得结论成立：

**前提**（存在性）

给定当前格局 $(\tau,\Sigma)$，记 $n=|\tau|$（可为 $0$）。要求：

1. 若 $n\ge 1$，令 $\rho\_n=\mathsf{last}(\tau)$，否则要求系统以一个初始引导规则 $\rho\_0\in P$ 开始（实现层面确保 $\tau$ 非空）；定义

$t_{\mathrm{eff}} \triangleq \mathsf{trigger}(\rho_n)[\,\mathsf{rhs}(\rho_n)\,].$

（即用 $\rho\_n$ 的触发上下文把其 rhs 填入，得到当前的有效项。）

2. 存在位置 $p\in\mathsf{Pos}(t\_{\mathrm{eff}})$ 与位点项 $\sigma\_{\mathrm{sel}}\in\mathsf{Site}(V,S)$ 使得

$t_{\mathrm{eff}} = C_{\mathrm{sel}}[\sigma_{\mathrm{sel}}],\quad C_{\mathrm{sel}}\in\mathcal{C},$

即在 $t\_{\mathrm{eff}}$ 的位置 $p$ 处选择了一个位点（非确定性选择）。

3. 令 $v\_{\mathrm{sel}}=\mathsf{id}(\sigma\_{\mathrm{sel}})$. 要求 $\Sigma(v\_{\mathrm{sel}})$ 已定义（存在验证位点）且记 $\nu = \Sigma(v\_{\mathrm{sel}})$. 进一步要求

$\mathsf{val\_state}(\nu)=\mathsf{AVAILABLE}.$

4. 设 $A=\mathsf{validator}(\nu)$。计算

$\rho_{n+1} = A(C_{\mathrm{sel}}).$

要求 $\rho\_{n+1}\ne\bot$ 且 $\rho\_{n+1}\in P$，并满足兼容性条件

$\mathsf{lhs}(\rho_{n+1}) = \mathsf{origin}(\nu) = \sigma_{\mathrm{sel}}.$

**结论**

在满足以上前提时定义

$\tau' = \tau\mathbin{\small{\tt ++}}[\rho_{n+1}].$

映射 $\Sigma'$ 按下述规则构造：

1. 初始将 $\Sigma'$ 设为 $\Sigma$ 的拷贝（即 $\Sigma'|\_{\mathsf{dom}(\Sigma)} = \Sigma$）。

2. 将触发的验证位点的状态改为 $\mathsf{CONSUMED}$：若 $v\_{\mathrm{sel}}\in\mathsf{dom}(\Sigma')$，令

$\Sigma'(v_{\mathrm{sel}}) = (\,\mathsf{origin}(\nu),\;\mathsf{CONSUMED},\;\mathsf{validator}(\nu)\, ).$

3. 对 $t\_{\mathrm{rhs}}(\rho\_{n+1})$ 中出现的每个位点项 $\sigma\_{\mathrm{new}}\in\mathsf{Sites}(\mathsf{rhs}(\rho\_{n+1}))$，若其标识符 $v\_{\mathrm{new}}=\mathsf{id}(\sigma\_{\mathrm{new}})$ 不在 $\mathsf{dom}(\Sigma')$ 中，则在 $\Sigma'$ 中新增映射：

$\Sigma'(v_{\mathrm{new}})=\Big(\sigma_{\mathrm{new}},\;\mathsf{AVAILABLE},\;\mathsf{init}(\sigma_{\mathrm{new}})\Big).$

若 $v\_{\mathrm{new}}\in\mathsf{dom}(\Sigma')$（即已存在），则保持原有映射不变（不覆盖）。

如上即定义了单步扩展关系。若所有前提成立则可进行该步扩展；若存在多种满足前提的选择（位置、可用位点、validator 返回不同规则），则归入非确定性分支。

---

## 8. 完整迹、可达性与终止

* **可扩展（extendable）格局**：若存在 $(\tau,\Sigma)\xrightarrow{;} (\tau',\Sigma')$，则称 $(\tau,\Sigma)$ 可扩展。

* **完整迹（complete trace）**：迹 $\tau$ 称为**完整**相对于映射 $\Sigma$，若对应格局 $(\tau,\Sigma)$ 不可扩展（即没有满足前提的单步扩展存在）。在上下文中常同时给出与该迹对应的最终映射 $\Sigma$。

* **可达性**：从初始格局 $(\tau\_0,\Sigma\_0)$ 出发，若存在有限步序列 $(\tau\_0,\Sigma\_0)\xrightarrow{;}\cdots\xrightarrow{;}(\tau,\Sigma)$ 则称 $(\tau,\Sigma)$ 可达。迹 $\tau$ 亦称为从初始格局可达。

* **终止**：若不存在任意无限的扩展序列（即所有从初始格局的执行均终止为完整迹），则称该系统在该初始格局下**强终止**。是否终止依赖于 validators 的性质与新名生成策略。

---

## 9. 可选变体与参数化项（给出清晰的接口以便用于不同研究方向）

本规范通过如下参数化点允许不同的实例化：

1. **validator 的计算能力**：可选择要求所有 $A$ 为总的可判定函数、或仅为部分可计算函数、或受限为有限状态机/正则函数等；不同选择影响理论性质（可达性、图灵完备性等）。

2. **并发语义**：本规范给出\*\*单位步（选择单一位点）\*\*的语义。若需并行扩展（在一个全局步骤中同时触发多个不相互冲突的位点），可定义并行扩展规则：在同一 $t\_{\mathrm{eff}}$ 的若干位置 $p\_1,\dots,p\_k$ 上选择互不冲突的位点并并行应用相应 validator，要求这些位点对应的 $v\_i$ 互不相同且各自为 $\mathsf{AVAILABLE}$。并行步骤的 $\Sigma'$ 同时更新所有触发位点为 $\mathsf{CONSUMED}$ 并加入新位点。并行变体需额外精化冲突判定规则。

3. **新名策略**：本规范用公理化函数 $\mathsf{fresh}$ 保证能生成新 id。实现时可采用基于计数器或全局名字空间的方法；若允许 $\mathsf{rhs}$ 指定具体 id（用于再使用已存在 id），则须在 $\Sigma'$ 合并策略中说明覆盖或保持原映射的准则。

---

## 10. 良构性条件（Well-formedness）

一个系统实例（即给定 $A,F,V,S,\mathsf{init},P$ 和初始格局 $(\tau\_0,\Sigma\_0)$）应满足下列良构性条件以便避免语义病态：

1. 对任意 $\nu$，$\mathsf{validator}(\nu)$ 对任何 $C$ 返回若非 $\bot$ 则必须返回一个与 $\mathsf{origin}(\nu)$ 左侧相同的规则节点（前文已述）。

2. 初始映射 $\Sigma\_0$ 中所有 $\nu$ 的 $\mathsf{val\_state}(\nu)=\mathsf{AVAILABLE}$ 或 $\mathsf{CONSUMED}$（任选），且 $\mathsf{dom}(\Sigma\_0)$ 与 $\tau\_0$ 中出现的位点 id 一致或为其子集／超集（实施细则中明确）。

3. $P$ 中的每个规则节点 $\rho=(\sigma,t,C)$ 满足每个 $\sigma'$ 若出现在 $t$ 中则其 $\mathsf{id}(\sigma')$ 可与 $\Sigma$ 中已定义的 id 冲突，而该如何处理须由系统策略定义（覆盖/忽略/错误）。一般推荐策略为：若 $\mathsf{id}(\sigma')\notin\mathsf{dom}(\Sigma)$ 则视为新位点并由 $\mathsf{init}$ 初始化。

---

## 11. 便于形式化证明的辅助定义

* **位置对应上下文**：定义操作 $\mathsf{Ctx}(t,p)$ 返回上下文 $C$（在位置 $p$ 处置空位）使得 $t=C[t|\_p]$。

* **选择谓词**：$\mathsf{select}(t, p)$ 当且仅当 $t|\_p\in\mathsf{Site}(V,S)$。

* **产生集合**：若 $\rho\in P$，定义 $\mathsf{NewIds}(\rho,\Sigma)={\mathsf{id}(\sigma)\mid \sigma\in\mathsf{Sites}(\mathsf{rhs}(\rho))\text{ 且 }\mathsf{id}(\sigma)\notin\mathsf{dom}(\Sigma)}$。

